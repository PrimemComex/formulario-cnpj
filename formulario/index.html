<!DOCTYPE html> <html lang="pt-BR"> <head> <meta charset="UTF-8"> <title>Formulário de CNPJ</title> <style> body { font-family: Arial, sans-serif; margin: 20px; } .form-container { max-width: 400px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; } .error { color: red; display: none; } .result { margin-top: 10px; padding: 10px; border: 1px solid #ddd; display: none; } #create-deal-btn { margin-top: 10px; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; display: none; } #create-deal-btn:hover { background-color: #218838; } #status-message { margin-top: 10px; padding: 10px; border: 1px solid #28a745; color: #28a745; display: none; } #status-message.error { border: 1px solid #ff0000; color: #ff0000; } </style> </head> <body> <div class="form-container"> <h2>Inserir CNPJ</h2> <form id="cnpj-form" enctype="multipart/form-data"> <label for="cnpj">CNPJ:</label><br> <input type="text" id="cnpj" name="cnpj" placeholder="99.999.999/9999-99" required><br> <p id="error-message" class="error">CNPJ inválido! Use 14 dígitos (ex.: 12.345.678/0001-99).</p>
<label for="conhecimento_embarque">Conhecimento de Embarque:</label><br>
<input type="text" id="conhecimento_embarque" name="conhecimento_embarque" placeholder="Digite o conhecimento de embarque" required><br><br>

<label for="anexo">Anexar Arquivo (PDF, Imagem, etc.):</label><br>
<input type="file" id="anexo" name="anexo" accept=".pdf,.jpg,.jpeg,.png" multiple><br><br>

<button type="submit">Buscar Dados</button>

</form> <div id="result" class="result"> <h3>Dados da Empresa</h3> <p><strong>Razão Social:</strong> <span id="razao_social"></span></p> <p><strong>Email:</strong> <span id="email"></span></p> <p><strong>Telefone:</strong> <span id="telefone"></span></p> <button id="create-deal-btn" onclick="createDeal()">Criar Negócio</button> </div> <div id="status-message"></div> </div> <script> let companyId = null; let filesToUpload = []; let conhecimentoEmbarque = ""; let companyData = null;
function formatCNPJ(cnpj) {
cnpj = cnpj.replace(/[^\d]/g, "");
if (cnpj.length === 14) {
return ${cnpj.substr(0, 2)}.${cnpj.substr(2, 3)}.${cnpj.substr(5, 3)}/${cnpj.substr(8, 4)}-${cnpj.substr(12, 2)};
}
return cnpj;
}

function cleanCNPJ(cnpj) {
return cnpj.replace(/[^\d]/g, "").trim();
}

function showStatusMessage(message, isError = false) {
const statusDiv = document.getElementById("status-message");
statusDiv.textContent = message;
statusDiv.style.display = "block";
statusDiv.classList.toggle("error", isError);
}

function fileToBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = () => resolve(reader.result.split(',')[1]);
reader.onerror = error => reject(error);
reader.readAsDataURL(file);
});
}

async function fetchCNPJFromReceita(cnpjClean) {
try {
const response = await fetch(https://www.receitaws.com.br/v1/cnpj/${cnpjClean});
if (!response.ok) throw new Error("Erro ao consultar CNPJ na Receita Federal: " + response.statusText);
const data = await response.json();
if (data.status !== "OK") throw new Error("CNPJ não encontrado ou inválido na Receita Federal");
return {
TITLE: data.nome,
EMAIL: data.email ? [{ VALUE: data.email, VALUE_TYPE: "WORK" }] : [],
PHONE: data.telefone ? [{ VALUE: data.telefone, VALUE_TYPE: "WORK" }] : [],
UF_CRM_25C6A52B: formatCNPJ(cnpjClean)
};
} catch (error) {
throw new Error("Erro ao consultar CNPJ: " + error.message);
}
}

async function addCompanyToBitrix(companyData) {
const companyAddWebhook = "https://primem.bitrix24.com.br/rest/89/novo_token_aqui/crm.company.add";
const payload = { fields: companyData };
console.log("Cadastrando empresa com URL:", companyAddWebhook, "Dados:", JSON.stringify(payload, null, 2));
const response = await fetch(companyAddWebhook, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify(payload)
});
if (!response.ok) throw new Error("Erro ao cadastrar empresa: " + response.statusText);
const data = await response.json();
console.log("Resposta do cadastro:", JSON.stringify(data, null, 2));
if (!data.result) throw new Error("Falha ao cadastrar empresa: " + (data.error_description || "Erro desconhecido"));
return data.result; // ID da nova empresa
}

document.getElementById("cnpj-form").addEventListener("submit", async function(event) {
event.preventDefault();
const cnpjInput = document.getElementById("cnpj").value;
const cnpjClean = cleanCNPJ(cnpjInput);
const cnpjFormatted = formatCNPJ(cnpjClean);
const errorMessage = document.getElementById("error-message");
const resultDiv = document.getElementById("result");
const createDealBtn = document.getElementById("create-deal-btn");
filesToUpload = document.getElementById("anexo").files;
conhecimentoEmbarque = document.getElementById("conhecimento_embarque").value;

if (cnpjClean.length !== 14 || isNaN(cnpjClean)) {
errorMessage.style.display = "block";
resultDiv.style.display = "none";
createDealBtn.style.display = "none";
showStatusMessage("CNPJ inválido. Por favor, insira 14 dígitos.", true);
return;
}
errorMessage.style.display = "none";

// Verificar arquivos anexados
let fileNames = [];
if (filesToUpload.length > 0) {
for (let i = 0; i < filesToUpload.length; i++) {
fileNames.push(filesToUpload[i].name);
}
console.log("Arquivos anexados: " + fileNames.join(", "));
showStatusMessage("Arquivos anexados: " + fileNames.join(", "));
} else {
console.log("Nenhum arquivo anexado.");
showStatusMessage("Nenhum arquivo anexado.");
}

// Webhook para buscar empresas (crm.company.list)
const companyListWebhook = "https://primem.bitrix24.com.br/rest/89/2h0usfzkv0bo8jqo/crm.company.list";
const queryUrl = ${companyListWebhook}?filter[UF_CRM_25C6A52B]=${encodeURIComponent(cnpjFormatted)}&select[]=ID&select[]=TITLE&select[]=EMAIL&select[]=PHONE&select[]=UF_CRM_25C6A52B;

try {
console.log("Buscando empresa com URL:", queryUrl);
const response = await fetch(queryUrl);
if (!response.ok) throw new Error("Erro ao buscar empresa: " + response.statusText);
const data = await response.json();
console.log("Resposta da busca:", JSON.stringify(data, null, 2));

// Filtrar empresas que correspondem ao CNPJ
const matchingCompanies = data.result.filter(company => {
const companyCnpj = company.UF_CRM_25C6A52B ? String(company.UF_CRM_25C6A52B).trim() : "";
const cleanCompanyCnpj = cleanCNPJ(companyCnpj);
console.log("Comparando CNPJ da empresa:", companyCnpj, "limpo:", cleanCompanyCnpj, "com:", cnpjClean);
return cleanCompanyCnpj === cnpjClean && companyCnpj !== "";
});
console.log("Empresas correspondentes:", JSON.stringify(matchingCompanies, null, 2));

if (matchingCompanies.length > 0) {
companyData = matchingCompanies[0]; // Empresa encontrada no Bitrix24
companyId = companyData.ID;
showStatusMessage("Empresa encontrada no Bitrix24!");
} else {
// CNPJ não encontrado, consultar Receita Federal
showStatusMessage("CNPJ não encontrado no Bitrix24. Consultando Receita Federal...");
companyData = await fetchCNPJFromReceita(cnpjClean);
showStatusMessage("CNPJ encontrado na Receita Federal. Cadastrando empresa no Bitrix24...");
companyId = await addCompanyToBitrix(companyData);
companyData.ID = companyId;
showStatusMessage("Empresa cadastrada com sucesso no Bitrix24!");
}

console.log("Empresa selecionada:", JSON.stringify(companyData, null, 2));
document.getElementById("razao_social").textContent = companyData.TITLE || "Não informado";
document.getElementById("email").textContent = companyData.EMAIL?.[0]?.VALUE || "Não informado";
document.getElementById("telefone").textContent = companyData.PHONE?.[0]?.VALUE || "Não informado";
resultDiv.style.display = "block";
createDealBtn.style.display = "block";
} catch (error) {
console.error("Erro na busca:", error);
showStatusMessage("Erro ao buscar/cadastrar empresa: " + error.message, true);
}
});

async function createDeal() {
if (!companyId) {
showStatusMessage("Nenhuma empresa selecionada.", true);
return;
}

// Webhook para criar negócios (crm.deal.add)
const dealAddWebhook = "https://primem.bitrix24.com.br/rest/89/8csyfkefuj46r22z/crm.deal.add";
const dealFields = {
TITLE: "Conhecimento de embarque desconhecido",
COMPANY_ID: companyId,
UF_CRM_1706725043860: conhecimentoEmbarque
};

try {
console.log("Criando negócio com URL:", dealAddWebhook, "Dados:", JSON.stringify(dealFields, null, 2));
const dealResponse = await fetch(dealAddWebhook, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ fields: dealFields })
});
if (!dealResponse.ok) throw new Error("Erro ao criar negócio: " + dealResponse.statusText);
const dealData = await dealResponse.json();
console.log("Resposta da criação do negócio:", JSON.stringify(dealData, null, 2));

if (!dealData.result) {
throw new Error("Falha ao criar negócio: " + (dealData.error_description || "Erro desconhecido"));
}

const dealId = dealData.result;
showStatusMessage("Negócio criado (ID: " + dealId + ")");

if (filesToUpload.length > 0) {
const file = filesToUpload[0];
const base64File = await fileToBase64(file);
console.log("Arquivo convertido para Base64: " + file.name);

// Webhook para atualizar negócios (crm.deal.update)
const dealUpdateWebhook = "https://primem.bitrix24.com.br/rest/89/chy7e1hyc3ns9svu/crm.deal.update";
const fileData = {
id: dealId,
fields: {
UF_CRM_1745685384: { fileData: [file.name, base64File] }
}
};
console.log("Enviando arquivo com URL:", dealUpdateWebhook, "Dados:", JSON.stringify(fileData, null, 2));

const updateResponse = await fetch(dealUpdateWebhook, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify(fileData)
});
const updateData = await updateResponse.json();
console.log("Resposta do upload:", JSON.stringify(updateData, null, 2));

if (!updateResponse.ok || !updateData.result) {
throw new Error("Erro ao anexar arquivo: " + (updateData.error_description || updateResponse.statusText));
}
showStatusMessage("Arquivo anexado com sucesso!");
} else {
showStatusMessage("Nenhum arquivo anexado.");
}
} catch (error) {
console.error("Erro:", error);
showStatusMessage("Erro: " + error.message, true);
}
}
</script>

</body> </html>
