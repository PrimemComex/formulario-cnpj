// Função para formatar o CNPJ com pontos e traços
function formatCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]/g, "");
    if (cnpj.length === 14) {
        return `${cnpj.substr(0, 2)}.${cnpj.substr(2, 3)}.${cnpj.substr(5, 3)}/${cnpj.substr(8, 4)}-${cnpj.substr(12, 2)}`;
    }
    return cnpj;
}

// Função para limpar o CNPJ (apenas números)
function cleanCNPJ(cnpj) {
    return cnpj.replace(/[^\d]/g, "");
}

// Manipulador de envio do formulário
document.getElementById("cnpj-form").addEventListener("submit", async function(event) {
    event.preventDefault();
    const cnpjInput = document.getElementById("cnpj").value;
    const cnpjFormatted = formatCNPJ(cnpjInput);
    const cnpjClean = cleanCNPJ(cnpjInput);
    const errorMessage = document.getElementById("error-message");
    const resultDiv = document.getElementById("result");
    const createDealBtn = document.getElementById("create-deal-btn");

    // Validação do CNPJ
    if (cnpjClean.length !== 14) {
        errorMessage.style.display = "block";
        resultDiv.style.display = "none";
        createDealBtn.style.display = "none";
        alert("CNPJ inválido. Por favor, insira 14 dígitos.");
        return;
    }
    errorMessage.style.display = "none";

    // Busca da empresa via proxy
    try {
        const proxyUrl = "/.netlify/functions/proxy/"; // Ajuste para o seu proxy
        const fieldCNPJ = "UF_CRM_25C6A52B"; // SUBSTITUA PELO CAMPO CORRETO

        // Tentar buscar com CNPJ formatado
        let searchUrl = `${proxyUrl}crm.company.list?filter[${fieldCNPJ}]=${encodeURIComponent(cnpjFormatted)}&select[]=ID&select[]=TITLE&select[]=EMAIL&select[]=PHONE`;
        console.log("Buscando com CNPJ formatado:", searchUrl);
        let response = await fetch(searchUrl);
        let data = await response.json();
        console.log("Resposta com CNPJ formatado:", data);

        // Se não encontrar, tentar com CNPJ sem formatação
        if (!data.result || data.result.length === 0) {
            searchUrl = `${proxyUrl}crm.company.list?filter[${fieldCNPJ}]=${encodeURIComponent(cnpjClean)}&select[]=ID&select[]=TITLE&select[]=EMAIL&select[]=PHONE`;
            console.log("Buscando com CNPJ sem formatação:", searchUrl);
            response = await fetch(searchUrl);
            data = await response.json();
            console.log("Resposta com CNPJ sem formatação:", data);
        }

        // Filtrar a empresa com o CNPJ exato
        if (data.result && data.result.length > 0) {
            const company = data.result.find(c => c[fieldCNPJ] === cnpjFormatted || c[fieldCNPJ] === cnpjClean);
            if (company) {
                companyId = company.ID;
                document.getElementById("razao_social").textContent = company.TITLE || "Não informado";
                document.getElementById("email").textContent = company.EMAIL?.[0]?.VALUE || "Não informado";
                document.getElementById("telefone").textContent = company.PHONE?.[0]?.VALUE || "Não informado";
                resultDiv.style.display = "block";
                createDealBtn.style.display = "block";
                alert("Empresa encontrada com sucesso!");
            } else {
                companyId = null;
                resultDiv.style.display = "none";
                createDealBtn.style.display = "none";
                alert("Nenhuma empresa encontrada com este CNPJ.");
            }
        } else {
            companyId = null;
            resultDiv.style.display = "none";
            createDealBtn.style.display = "none";
            alert("Nenhuma empresa encontrada com este CNPJ.");
        }
    } catch (error) {
        alert("Erro ao buscar dados da empresa: " + error.message);
        console.error("Erro na requisição:", error);
    }
});
