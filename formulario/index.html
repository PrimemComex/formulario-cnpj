async function fetchAllPages(cnpjFormatted, cnpjClean) {
    const proxyUrl = "/.netlify/functions/proxy/";
    let start = 0;
    let allResults = [];
    let total = 0;

    while (true) {
        const queryUrl = `${proxyUrl}crm.company.list?filter[UF_CRM_25C6A52B]=${encodeURIComponent(cnpjFormatted)}&select[]=ID&select[]=TITLE&select[]=EMAIL&select[]=PHONE&select[]=UF_CRM_25C6A52B&start=${start}`;
        console.log("URL requisitada:", queryUrl);

        try {
            const response = await fetch(queryUrl);
            if (!response.ok) throw new Error("Erro na requisição: " + response.statusText);
            const data = await response.json();
            console.log("Resposta da API:", JSON.stringify(data, null, 2));

            if (data.result && data.result.length > 0) {
                const filteredCompanies = data.result.filter(c => cleanCNPJ(c.UF_CRM_25C6A52B || "") === cnpjClean);
                allResults = allResults.concat(filteredCompanies);
            }

            total = data.total || total;
            if (data.next && allResults.length < total) {
                start = data.next;
            } else {
                break;
            }
        } catch (error) {
            console.error("Erro ao buscar página:", error);
            throw error;
        }
    }
    return allResults;
}

// Funções auxiliares
function formatCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]/g, "");
    if (cnpj.length === 14) {
        return `${cnpj.substr(0, 2)}.${cnpj.substr(2, 3)}.${cnpj.substr(5, 3)}/${cnpj.substr(8, 4)}-${cnpj.substr(12, 2)}`;
    }
    return cnpj;
}

function cleanCNPJ(cnpj) {
    return cnpj.replace(/[^\d]/g, "").trim();
}

// Integração com o formulário
document.getElementById("cnpj-form").addEventListener("submit", async (event) => {
    event.preventDefault();
    const cnpjInput = document.getElementById("cnpj").value;
    const cnpjClean = cleanCNPJ(cnpjInput);
    const cnpjFormatted = formatCNPJ(cnpjClean);

    if (cnpjClean.length !== 14 || isNaN(cnpjClean)) {
        alert("CNPJ inválido! Use 14 dígitos (ex.: 12.345.678/0001-99).");
        return;
    }

    try {
        const companies = await fetchAllPages(cnpjFormatted, cnpjClean);
        if (companies.length > 0) {
            const company = companies[0]; // Pega a primeira empresa correspondente
            console.log("Empresa encontrada:", company);
            // Exibir os dados no formulário
            document.getElementById("razao_social").textContent = company.TITLE || "Não informado";
            document.getElementById("email").textContent = company.EMAIL?.[0]?.VALUE || "Não informado";
            document.getElementById("telefone").textContent = company.PHONE?.[0]?.VALUE || "Não informado";
            document.getElementById("result").style.display = "block";
        } else {
            alert("Nenhuma empresa encontrada para o CNPJ: " + cnpjFormatted);
        }
    } catch (error) {
        alert("Erro ao buscar empresa: " + error.message);
    }
});
