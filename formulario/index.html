<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Formulário de CNPJ</title>
    <style>
        /* Mantenha os estilos anteriores */
    </style>
</head>
<body>
    <!-- Mantenha o HTML anterior -->
    
    <script>
        // Configurações importantes
        const BITRIX_WEBHOOK = 'https://primem.bitrix24.com.br/rest/89/2h0usfzkv0bo8jqo';
        const RECEITAWS_TOKEN = 'SEU_TOKEN_RECEITAWS'; // Obtenha em https://receitaws.com.br/

        // ... (mantenha as funções formatCNPJ, cleanCNPJ e showStatusMessage)

        async function consultarReceitaFederal(cnpj) {
            const url = `https://receitaws.com.br/v1/cnpj/${cnpj}?token=${RECEITAWS_TOKEN}`;
            
            try {
                document.getElementById('loading').style.display = 'block';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.status === 'ERROR') {
                    throw new Error(data.message);
                }

                return {
                    razao_social: data.nome || 'Não informado',
                    endereco: this.formatarEndereco(data),
                    telefone: data.telefone || 'Não informado',
                    email: data.email || 'Não informado',
                    situacao: data.situacao || 'Desconhecida'
                };
            } catch (error) {
                console.error('Erro na consulta RF:', error);
                throw new Error(`Falha na consulta: ${error.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function formatarEndereco(data) {
            const parts = [];
            if (data.logradouro) parts.push(data.logradouro);
            if (data.numero) parts.push(data.numero);
            if (data.bairro) parts.push(data.bairro);
            if (data.municipio) parts.push(`${data.municipio}/${data.uf}`);
            if (data.cep) parts.push(`CEP: ${data.cep}`);
            
            return parts.join(', ').replace(/, , /g, ', ') || 'Endereço não disponível';
        }

        async function buscarEmpresaBitrix(cnpjFormatado) {
            const url = `${BITRIX_WEBHOOK}/crm.company.list?filter[UF_CRM_25C6A52B]=${encodeURIComponent(cnpjFormatado)}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok || data.error) {
                    throw new Error(data.error_description || 'Erro na consulta ao Bitrix');
                }

                return data.result;
            } catch (error) {
                console.error('Erro na consulta Bitrix:', error);
                throw error;
            }
        }

        async function criarEmpresaBitrix(dados) {
            const url = `${BITRIX_WEBHOOK}/crm.company.add`;
            
            const companyData = {
                fields: {
                    TITLE: dados.razao_social,
                    COMPANY_TYPE: 'C',
                    UF_CRM_25C6A52B: dados.cnpj_formatado,
                    PHONE: [{ VALUE: dados.telefone, VALUE_TYPE: 'WORK' }],
                    EMAIL: [{ VALUE: dados.email, VALUE_TYPE: 'WORK' }],
                    ADDRESS: dados.endereco,
                    UF_CRM_SITUACAO_CADASTRAL: dados.situacao
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(companyData)
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.result) {
                    throw new Error(data.error_description || 'Erro ao criar empresa no Bitrix');
                }

                return data.result;
            } catch (error) {
                console.error('Erro na criação da empresa:', error);
                throw error;
            }
        }

        document.getElementById("cnpj-form").addEventListener("submit", async function(event) {
            event.preventDefault();
            
            // ... (mantenha a validação inicial do CNPJ)

            try {
                // 1. Buscar no Bitrix
                const empresasBitrix = await buscarEmpresaBitrix(cnpjFormatado);
                
                if (empresasBitrix.length > 0) {
                    // ... (exibir dados do Bitrix)
                } else {
                    // 2. Consultar Receita Federal se não encontrou
                    const dadosRF = await consultarReceitaFederal(cnpjClean);
                    
                    // 3. Criar empresa no Bitrix
                    const novoId = await criarEmpresaBitrix({
                        ...dadosRF,
                        cnpj_formatado: cnpjFormatado
                    });
                    
                    companyId = novoId;
                    
                    // 4. Atualizar UI
                    document.getElementById("razao_social").textContent = dadosRF.razao_social;
                    document.getElementById("endereco").textContent = dadosRF.endereco;
                    document.getElementById("telefone").textContent = dadosRF.telefone;
                    document.getElementById("email").textContent = dadosRF.email;
                    // ... (restante da atualização da UI)
                }
            } catch (error) {
                console.error("Erro no processo:", error);
                showStatusMessage(`Falha: ${error.message}`, true);
            }
        });

        // ... (mantenha as demais funções)
    </script>
</body>
</html>
